<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="T_RP_EXTRACCION_SIN_TARJETA" directorySegmentName="seg_0" id="763AA702-DC00-B5F7-C678-4F9D29F97F4E">
<sourceConnName>OL_ALTA</sourceConnName>
<sourceObjSchema>RAPIPAGO</sourceObjSchema>
<sourceObjName>T_RP_EXTRACCION_SIN_TARJETA</sourceObjName>
<createdBy>CDETKE</createdBy>
<createdTime>2021-12-17 12:26:52 UTC</createdTime>
<ownerDesignName>RAPIPAGO-TRANSACCIONES</ownerDesignName>
<actions>INSERT</actions>
<body><![CDATA[DECLARE
vInstancia VARCHAR2(100);
IdCodigoBarra VARCHAR2(30);
L_CODIGO_CLIENTE NUMBER; 
L_COD_ENTIDAD_EM NUMBER; 
L_COD_ENTIDAD_AG NUMBER; 
L_FACON_CIA NUMBER;
L_CUIT VARCHAR2(11);
L_COD_AGENTE NUMBER; 
L_IMP_TOTAL NUMBER;
L_CANTIDAD_REGISTROS NUMBER; 
L_USUARIO VARCHAR2(20); 
L_FONDEO_GIRE VARCHAR2(1); 
L_FECHA_PROCESO VARCHAR2(10);
L_COD_OPERATORIA VARCHAR2(5); 
L_COD_EMPRESA_PUESTO NUMBER; 
L_ID_EMPRESA_PUESTO VARCHAR2(30);
L_EXISTE_FONDEO NUMBER;
L_HABILITADO CHAR(1) :=0;
L_TIPO_DEBITO VARCHAR2(10);
L_EMP_OPERATORIA VARCHAR2(1);
L_DESC_OPERATORIA VARCHAR2(10);
L_PUESTO VARCHAR2(8);
L_ERROR VARCHAR2(4000):='';
L_ENTER VARCHAR2(10):=CHR(13)||CHR(10);
BEGIN 
    vInstancia:=RAPIPAGO.RP_FUNCIONES_UTILES.TRAER_INSTANCIA;
    L_DESC_OPERATORIA:='SANTANDER';
    L_HABILITADO:=0;
    IF L_DESC_OPERATORIA IS NOT NULL THEN
        BEGIN
            CASE vInstancia
                WHEN 'DESARROLLO' THEN 
                SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
                INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
                FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
                WHERE TIPO_DEBITO=L_DESC_OPERATORIA AND AMBIENTE=vInstancia AND ID_CODIGO_BARRRA=:NEW.ID_CODIGO_BARRA;
                WHEN 'TESTING' THEN
                SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
                INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
                FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
                WHERE TIPO_DEBITO=L_DESC_OPERATORIA AND AMBIENTE=vInstancia AND ID_CODIGO_BARRRA=:NEW.ID_CODIGO_BARRA;
                WHEN 'PRODUCCION' THEN 
                SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
                INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
                FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
                WHERE TIPO_DEBITO=L_DESC_OPERATORIA AND AMBIENTE=vInstancia AND ID_CODIGO_BARRRA=:NEW.ID_CODIGO_BARRA;
            END CASE;
        EXCEPTION
            WHEN OTHERS THEN
                L_HABILITADO:=0;
        END;                     
        IF L_HABILITADO=1 THEN 
            IF INSERTING AND :NEW.ID_TRANSACCION_ITEM_REFERENCIA IS NULL THEN
                ----- Aca antes estaba la pregunta de si es SOLO_DEBITO        
               ------ aca estaba el IF de solo_debito
                    L_IMP_TOTAL := ABS(:NEW.IMPORTE); 
                    L_CANTIDAD_REGISTROS := 1; 
                    L_USUARIO := SUBSTR(USER,1,20); 
                    L_FECHA_PROCESO := TO_CHAR(SYSDATE,'YYYY-MM-DD');
                    BEGIN                                                                                  
                        RAPIPAGO.GENERAR_PRE_FONDEO_AUTO@LINK_BK(L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_COD_AGENTE, L_IMP_TOTAL, L_CANTIDAD_REGISTROS, L_USUARIO, L_FONDEO_GIRE, L_FECHA_PROCESO, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO);
                    EXCEPTION
                        WHEN OTHERS THEN
                            L_ERROR:=L_ERROR||L_ENTER||'Problemas en la RegistraciÃ³n del PREFONDEO AUTOMATICO - Linea:'||$$PLSQL_line||' - '||SUBSTR(SQLERRM,1,1000);
                            RAISE_APPLICATION_ERROR(-20103,L_ERROR,True);
                    END;
            END IF;
        END IF;
    END IF;
 EXCEPTION
 WHEN OTHERS THEN
       L_ERROR:=L_ERROR||L_ENTER||'Linea:'||$$PLSQL_line||' - '||SUBSTR(SQLERRM,1,1000);
    IF vInstancia = 'TESTING' THEN
       GIRE.PKG_CORREOS.ENVIO_CORREO('lqa@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_EXTRACCION_SIN_TARJETA - '||vInstancia, L_ERROR, 'EXTRACCION_SANTANDER');
       GIRE.PKG_CORREOS.ENVIO_CORREO('lsrapi@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_EXTRACCION_SIN_TARJETA - '||vInstancia, L_ERROR, 'EXTRACCION_SANTANDER');
    ELSE IF vInstancia = 'PRODUCCION' THEN
         GIRE.PKG_CORREOS.ENVIO_CORREO('lsrapi@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_EXTRACCION_SIN_TARJETA - '||vInstancia, L_ERROR, 'EXTRACCION_SANTANDER');
         GIRE.PKG_CORREOS.ENVIO_CORREO('lsoportesistemas@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_EXTRACCION_SIN_TARJETA - '||vInstancia, L_ERROR, 'EXTRACCION_SANTANDER');
         GIRE.PKG_CORREOS.ENVIO_CORREO('lsoporterapipago@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_EXTRACCION_SIN_TARJETA - '||vInstancia, L_ERROR, 'EXTRACCION_SANTANDER');
       END IF;
    END IF;
END ;]]></body>
<triggerTime>BEFORE</triggerTime>
<owner>C3810AD6-77BE-D400-48EC-B9BB46870C6A</owner>
<table>1CEEF360-67ED-8AF6-B19F-B33E26D4EB0B</table>
</TriggerOraclev10g>