<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="T_RP_TRANSACCION_ITEM_FORMA_PA" directorySegmentName="seg_0" id="D98C74EE-1E41-F30A-F1CD-465B12DC68B5">
<sourceConnName>OL_ALTA</sourceConnName>
<sourceObjSchema>RAPIPAGO</sourceObjSchema>
<sourceObjName>T_RP_TRANSACCION_ITEM_FORMA_PA</sourceObjName>
<createdBy>CDETKE</createdBy>
<createdTime>2021-12-17 12:26:52 UTC</createdTime>
<ownerDesignName>RAPIPAGO-TRANSACCIONES</ownerDesignName>
<actions>INSERT</actions>
<body><![CDATA[DECLARE
VAR1 NUMBER;
VAR2 NUMBER;
VAR3 NUMBER;
DIAS VARCHAR(20 BYTE);
DIAS1 VARCHAR(20 BYTE);
DIAS2 VARCHAR(20 BYTE);
PLAZO VARCHAR(20 BYTE);
PLAZO1 VARCHAR(20 BYTE);
PLAZO2 VARCHAR(20 BYTE);
DIAS_PESOS VARCHAR(20 BYTE);
DIAS1_PESOS VARCHAR(20 BYTE);
DIAS2_PESOS VARCHAR(20 BYTE);
PLAZO_PESOS VARCHAR(20 BYTE);
PLAZO1_PESOS VARCHAR(20 BYTE);
PLAZO2_PESOS VARCHAR(20 BYTE);

wID_RAPICLUB  VARCHAR(20 BYTE) DEFAULT '51543824002200000232';
wID_PESOS     VARCHAR(20 BYTE) DEFAULT '0812030928uerizbtLJr'; 
wID_LINK      VARCHAR(20 BYTE) DEFAULT '53797188065600000935';
wID_PRISMA    VARCHAR(20 BYTE) DEFAULT '53797188065600000944';
wID_BOTON     VARCHAR(20 BYTE) DEFAULT '49710120200320171100';
wID_LINK_WA   VARCHAR(20 BYTE) DEFAULT '20200701131100000935';
wID_LINK_VIRTUAL  VARCHAR(20 BYTE) DEFAULT '20200701122000000935';

BEGIN
  IF (UPDATING) THEN
        :new.AUD_DATE_UPDATE               := TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS');
  END IF;
  
  if INSERTING then
       :new.AUD_DATE_INSERT               := TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS'); 

  END IF;
 
  IF INSERTING then
  
     SELECT RPTFP.ID_TIPO_VALOR into :new.ID_TIPO_VALOR
      FROM RAPIPAGO.RP_TRANSACCION_FORMA_PAGO RPTFP
      WHERE RPTFP.ID_TRANSACCION_FORMA_PAGO = :NEW.ID_TRANSACCION_FORMA_PAGO;
     if :new.MONEDA_PRINCIPAL = 1 then 
         update rapipago.rp_transaccion_item_comision
         SET ID_TIPO_VALOR = :new.ID_TIPO_VALOR
         WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM ;
     end if;  
     
     IF (:NEW.AUD_USER_INSERT <> 'CONECTOR') THEN
     
     
          -- Clearing por moneda
      
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS, PLAZO
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPRESA_PUESTO = ITE.ID_EMPRESA_PUESTO AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
           WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
             AND FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;
   
          -- Clearing PESOS
      
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS_PESOS, PLAZO_PESOS
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPRESA_PUESTO = ITE.ID_EMPRESA_PUESTO AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
           WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
             AND FTVI.ID_TIPO_VALOR = wID_PESOS;
 
          -- Analizar si aplica el Clearing para esta 1ra.condición  
     
          SELECT COUNT(1) into var1
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPRESA_PUESTO = ITE.ID_EMPRESA_PUESTO AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
             AND FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;
 
          -- Clearing por moneda
      
     
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS1, PLAZO1
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPR_PUESTO_MODALIDAD = ITE.ID_EMPR_PUESTO_MODALIDAD AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;

          -- Clearing PESOS
      
     
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS1_PESOS, PLAZO1_PESOS
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPR_PUESTO_MODALIDAD = ITE.ID_EMPR_PUESTO_MODALIDAD AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = wID_PESOS;
                    
          -- Analizar si aplica el Clearing para esta 2da.condición
                    
          SELECT COUNT(1) into var2
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_EMPR_PUESTO_MODALIDAD = ITE.ID_EMPR_PUESTO_MODALIDAD AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;
          
          -- Clearing por moneda
          
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS2, PLAZO2
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_CODIGO_BARRA = ITE.ID_CODIGO_BARRA AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;

          -- Clearing PESOS
          
          SELECT MAX(NVL(FTVIE.DIAS_CLEARING,FTVI.DIAS_CLEARING)),MAX(NVL(FTVIE.PLAZO_ADICIONAL,FTVI.PLAZO_ADICIONAL)) into DIAS2_PESOS, PLAZO2_PESOS
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_CODIGO_BARRA = ITE.ID_CODIGO_BARRA AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = wID_PESOS;
                    
          -- Analizar si aplica el Clearing para esta 3ra.condición
                    
          SELECT COUNT(1) into var3
          FROM RAPIPAGO.RP_TRANSACCION_ITEM ITE
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALORES FTV ON (FTV.ID_CODIGO_BARRA = ITE.ID_CODIGO_BARRA AND FTV.IS_DELETED = 'N')
          INNER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM FTVI ON (FTVI.ID_FILTRO_TIPOS_VALORES = FTV.ID_FILTRO_TIPOS_VALORES AND FTVI.IS_DELETED = 'N')
          LEFT OUTER JOIN RAPIPAGO.RP_FILTRO_TIPOS_VALS_ITEM_EXC FTVIE ON 
              (FTVIE.ID_FILTRO_TIPOS_VALS_ITEM = FTVI.ID_FILTRO_TIPOS_VALS_ITEM AND FTVIE.IS_DELETED = 'N' )
          WHERE ID_TRANSACCION_ITEM = :new.ID_TRANSACCION_ITEM
          AND   FTVI.ID_TIPO_VALOR = DECODE(:NEW.ID_TIPO_VALOR, wID_RAPICLUB, wID_PESOS, wID_LINK, wID_PESOS, wID_PRISMA, wID_PESOS, wID_BOTON, wID_PESOS, 
                                             wID_LINK_WA,wID_PESOS, wID_LINK_VIRTUAL, wID_PESOS, :NEW.ID_TIPO_VALOR) ;
       
        
        if var1 <> 0  then
        
          :new.DIAS_CLEARING           := DIAS;
          :new.PLAZO_ADICIONAL         := PLAZO;
            
        end if;

        if var2 <> 0  then
        
          :new.DIAS_CLEARING           := DIAS1;
          :new.PLAZO_ADICIONAL         := PLAZO1;
        
        end if;

        if var3 <> 0 then
     
          :new.DIAS_CLEARING           := DIAS2;
          :new.PLAZO_ADICIONAL         := PLAZO2;
         
        end if;
        
        if :new.DIAS_CLEARING = 0 and DIAS_PESOS <> 0 then
        
           :new.DIAS_CLEARING           := DIAS_PESOS;
           :new.PLAZO_ADICIONAL         := PLAZO_PESOS; 
           
        elsif :new.DIAS_CLEARING = 0 and DIAS1_PESOS <> 0 then 
        
           :new.DIAS_CLEARING           := DIAS1_PESOS;
           :new.PLAZO_ADICIONAL         := PLAZO1_PESOS; 
           
        elsif :new.DIAS_CLEARING = 0 and DIAS2_PESOS <> 0 then   
        
           :new.DIAS_CLEARING           := DIAS2_PESOS;
           :new.PLAZO_ADICIONAL         := PLAZO2_PESOS; 
           
        end if;
           
        
     END IF;
  END IF;   

 EXCEPTION
 WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END ;]]></body>
<triggerTime>BEFORE</triggerTime>
<owner>C3810AD6-77BE-D400-48EC-B9BB46870C6A</owner>
<table>75573F48-80F8-0187-D2B6-3D0417545A86</table>
</TriggerOraclev10g>