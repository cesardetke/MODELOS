<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="T_RP_DEVOLUCION_DEBITO" directorySegmentName="seg_0" id="4930A159-2393-5A1B-65C6-79B0AEBCD8F4">
<sourceConnName>OL_ALTA</sourceConnName>
<sourceObjSchema>RAPIPAGO</sourceObjSchema>
<sourceObjName>T_RP_DEVOLUCION_DEBITO</sourceObjName>
<createdBy>CDETKE</createdBy>
<createdTime>2021-12-17 12:26:52 UTC</createdTime>
<ownerDesignName>RAPIPAGO-TRANSACCIONES</ownerDesignName>
<actions>INSERT</actions>
<body><![CDATA[DECLARE
EsSoloDebito NUMBER(1);
vInstancia VARCHAR2(100);
IdCodigoBarra VARCHAR2(30);
L_CODIGO_CLIENTE NUMBER; 
L_COD_ENTIDAD_EM NUMBER; 
L_COD_ENTIDAD_AG NUMBER; 
L_FACON_CIA NUMBER;
L_CUIT VARCHAR2(11);
L_COD_AGENTE NUMBER; 
L_IMP_TOTAL NUMBER;
L_CANTIDAD_REGISTROS NUMBER; 
L_USUARIO VARCHAR2(20); 
L_FONDEO_GIRE VARCHAR2(1); 
L_FECHA_PROCESO VARCHAR2(10);
L_COD_OPERATORIA VARCHAR2(5); 
L_COD_EMPRESA_PUESTO NUMBER; 
L_ID_EMPRESA_PUESTO VARCHAR2(30);
L_EXISTE_FONDEO NUMBER;
L_HABILITADO CHAR(1);
L_TIPO_DEBITO VARCHAR2(10);
L_PUESTO VARCHAR2(8);
BEGIN
    /* EN LA TABLA RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM SE ENCUENTRAN LOS PARAMETROS PARA EJECUTAR ESTE TRIGGER */
    vInstancia:=RAPIPAGO.RP_FUNCIONES_UTILES.TRAER_INSTANCIA;
    --- BUSCO EL PUESTO
    SELECT LPAD(P.PUESTO,6,'0') INTO L_PUESTO FROM RAPIPAGO.RP_PUESTO P 
    INNER JOIN RAPIPAGO.RP_TRANSACCION T ON T.ID_PUESTO=P.ID_PUESTO AND T.ID_TRANSACCION=:NEW.ID_TRANSACCION;
    CASE vInstancia
        WHEN 'DESARROLLO' THEN 
        SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
        INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
        FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
        WHERE TIPO_DEBITO='PRISMA' AND AMBIENTE=vInstancia;
        WHEN 'TESTING' THEN
        SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
        INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
        FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
        WHERE TIPO_DEBITO='PRISMA' AND AMBIENTE=vInstancia;
        WHEN 'PRODUCCION' THEN 
        SELECT TIPO_DEBITO, ID_CODIGO_BARRRA, CODIGO_CLIENTE, COD_ENTIDAD_EMPRESA, COD_ENTIDAD_AGENTE, FACON_CIA, CUIT, FONDEO_GIRE, COD_OPERATORIA, COD_EMPRESA_PUESTO, ID_EMPRESA_PUESTO, HABILITADO 
        INTO L_TIPO_DEBITO, IdCodigoBarra, L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_FONDEO_GIRE, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO, L_HABILITADO
        FROM RAPIPAGO.RP_DEVOLUCION_DEBITO_PARAM
        WHERE TIPO_DEBITO='PRISMA' AND AMBIENTE=vInstancia;
    END CASE;
    IF L_HABILITADO=1 THEN 
        IF INSERTING AND :NEW.ID_CODIGO_BARRA=IdCodigoBarra AND :NEW.ID_TRANSACCION_ITEM_REFERENCIA IS NULL THEN
            SELECT NVL(COUNT(1),0)
            INTO EsSoloDebito 
            FROM RAPIPAGO.RP_TRANSACCION T, RAPIPAGO.RP_PUESTO P, RAPIPAGO.RP_AGENTE_SUCURSAL A
            WHERE T.ID_TRANSACCION=:NEW.ID_TRANSACCION
            AND T.ID_PUESTO=P.ID_PUESTO
            AND P.ID_AGENTE_SUCURSAL=A.ID_AGENTE_SUCURSAL 
            AND A.SOLO_DEBITO='Y';        
            IF EsSoloDebito>0 THEN
                L_IMP_TOTAL := ABS(:NEW.IMPORTE); 
                L_CANTIDAD_REGISTROS := 1; 
                L_USUARIO := SUBSTR(USER,1,20); 
                L_FECHA_PROCESO := TO_CHAR(SYSDATE,'YYYY-MM-DD');
                INSERT INTO FACON.FACTURAS_01897_000 (CLIENTE, DOCUMENTO, FACTURA, FH_DISPONIBILIDAD, FH_VENCIMIENTO1, IMPORTE_1, BARRA)
                SELECT HP.REFERENCE_NUMBER, HP.NUMERO_DOC, HP.CODIGO_TRANSACCION, TRUNC(SYSDATE+1), TRUNC(SYSDATE), :NEW.IMPORTE
                , '5836'||HP.REFERENCE_NUMBER||LPAD(HP.NUMERO_DOC,8,'0')||LPAD(ABS(:NEW.IMPORTE)*100,8,'0')||TO_CHAR(SYSDATE,'DDMMYYYY')||'01897'
                FROM HERMES.PRISMA_HISTORICO HP 
                WHERE HP.TIPO_OPERACION='P' AND TRUNC(HP.FH_ACTUALIZACION)=TO_DATE(SUBSTR(:NEW.FECHA_LECTURA,1,10),'YYYY-MM-DD')
                AND HP.PUESTO=L_PUESTO AND HP.REFERENCE_NUMBER=:NEW.REFERENCIA_DEBITO;
                BEGIN
                   --- INSERTO VALOR INICIAL DE PRE_FONDEO DE 0.01 PARA SUCURSALES SOLO DEBITO, SINO EN EL PRIMER PAGO NO TIENE SALDO
                   SELECT NVL(COUNT(1),0) INTO L_EXISTE_FONDEO 
                   FROM STO.RP_PRE_FONDEO
                   WHERE COD_OPERATORIA = L_COD_OPERATORIA;
                   IF L_EXISTE_FONDEO = 0 THEN
                      RAPIPAGO.FUERZO_PRE_FONDEO@LINK_BK(L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, 0.01, L_USUARIO, L_FONDEO_GIRE, L_FECHA_PROCESO, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO);
                   END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        GIRE.PKG_CORREOS.ENVIO_CORREO('lsrapi@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_DEVOLUCION_DEBITO_PRISMA - '||vInstancia, 'Problemas al crear el saldo $0.01 de inicio - '||SUBSTR(SQLERRM,1,1000), 'TRIGGER DEVOLUCION PRISMA');                    
                END;
                BEGIN                                                                                  
                    IF L_ID_EMPRESA_PUESTO IS NOT NULL THEN
                        RAPIPAGO.GENERAR_PRE_FONDEO@LINK_BK(L_CODIGO_CLIENTE, L_COD_ENTIDAD_EM, L_COD_ENTIDAD_AG, L_FACON_CIA, L_CUIT, L_COD_AGENTE, L_IMP_TOTAL, L_CANTIDAD_REGISTROS, L_USUARIO, L_FONDEO_GIRE, L_FECHA_PROCESO, L_COD_OPERATORIA, L_COD_EMPRESA_PUESTO, L_ID_EMPRESA_PUESTO);
                    END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        GIRE.PKG_CORREOS.ENVIO_CORREO('lsrapi@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_DEVOLUCION_DEBITO_PRISMA - '||vInstancia, 'Problemas en la RegistraciÃ³n del PREFONDEO - '||SUBSTR(SQLERRM,1,1000), 'TRIGGER DEVOLUCION PRISMA');
                END;
            END IF;
        END IF;
    END IF;
 EXCEPTION
 WHEN OTHERS THEN
       GIRE.PKG_CORREOS.ENVIO_CORREO('lsrapi@gire.com', 'ERROR - Trigger RAPIPAGO.T_RP_DEVOLUCION_DEBITO_PRISMA - '||vInstancia, SUBSTR(SQLERRM,1,1000), 'TRIGGER DEVOLUCION PRISMA');
END ;]]></body>
<triggerTime>BEFORE</triggerTime>
<owner>C3810AD6-77BE-D400-48EC-B9BB46870C6A</owner>
<table>1CEEF360-67ED-8AF6-B19F-B33E26D4EB0B</table>
</TriggerOraclev10g>