<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="T_RP_AGENTE_SUCURSAL_GEOREFERE" directorySegmentName="seg_0" id="3C57CDFA-2F02-B564-63B3-4BD302B99B04">
<sourceConnName>PROD</sourceConnName>
<sourceObjSchema>RAPIPAGO</sourceObjSchema>
<sourceObjName>T_RP_AGENTE_SUCURSAL_GEOREFERE</sourceObjName>
<createdBy>CDETKE</createdBy>
<createdTime>2022-01-04 18:03:24 UTC</createdTime>
<ownerDesignName>WEBSERVICERP-BK</ownerDesignName>
<actions>UPDATE</actions>
<body><![CDATA[declare 
   wCantidad number;
begin

      IF :NEW.COD_SUCURSAL IS NOT NULL THEN

         select count(1) into wCantidad 
           from GEOREFERENCIACION.POINTSUCURSALRAPIPAGO
          where ID = :NEW.COD_SUCURSAL;
            
         if wCantidad = 0 then -- Insert 
         
            insert into GEOREFERENCIACION.POINTSUCURSALRAPIPAGO
            (ID,                 CREATION_DATE, MODIFICATION_DATE, VERSION,             X,            Y)
            VALUES
            (:NEW.COD_SUCURSAL,        sysdate,           sysdate,       0, :NEW.LONGITUD, :NEW.LATITUD);

         ELSIF wCantidad <> 0 AND
                 (   (nvl(:old.LONGITUD, 0) <> :new.LONGITUD) OR          
                     (nvl(:old.LATITUD , 0) <> :new.LATITUD )
                 ) then   

            UPDATE GEOREFERENCIACION.POINTSUCURSALRAPIPAGO
               SET Y = :NEW.LATITUD, 
                   X = :NEW.LONGITUD,
                   MODIFICATION_DATE = SYSDATE,
                   version = nvl(version, 0) + 1
             WHERE ID = :NEW.COD_SUCURSAL;

             if sql%rowcount = 0 then

                  insert into GEOREFERENCIACION.POINTSUCURSALRAPIPAGO
                  (ID,                 CREATION_DATE, MODIFICATION_DATE, VERSION,             X,            Y)
                  VALUES
                  (:NEW.COD_SUCURSAL,        sysdate,           sysdate,       0, :NEW.LONGITUD, :NEW.LATITUD);
             end if; 
         END IF;      

         IF :NEW.WF_STATUS = 'ELI' AND nvl(:OLD.WF_STATUS, 'NULO') <> 'ELI'  THEN  
            DELETE GEOREFERENCIACION.POINTSUCURSALRAPIPAGO
             WHERE ID = :OLD.COD_SUCURSAL;
         END IF;  

      else         
         RAPIPAGO.RP_FUNCIONES_UTILES.LOG_PROCESO_CENTRAL( $$PLSQL_UNIT, 'IF :NEW.COD_SUCURSAL IS NULL.');
      END IF;      

EXCEPTION
     WHEN OTHERS THEN
       RAPIPAGO.RP_FUNCIONES_UTILES.LOG_PROCESO_CENTRAL( $$PLSQL_UNIT, 'Error en ' || $$PLSQL_UNIT || ': ' || SQLERRM, 'S');
       RAISE ;
END ;]]></body>
<triggerTime>AFTER</triggerTime>
<owner>C62C8F1E-2A53-0B75-10F9-F26CB65E46CC</owner>
<table>80B68678-7C49-E212-35AF-0A3E3BDDD305</table>
</TriggerOraclev10g>